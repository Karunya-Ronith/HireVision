{% extends 'base.html' %}

{% block title %}Resume Builder - HireVision{% endblock %}

{% block extra_css %}
<style>
    /* Modern Resume Builder Styles */
    .resume-builder-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .builder-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem 0;
    }

    .builder-title {
        font-size: 3rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .builder-subtitle {
        font-size: 1.25rem;
        color: var(--secondary-color);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    /* Step Wizard */
    .step-wizard {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .wizard-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
    }

    .wizard-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .wizard-subtitle {
        opacity: 0.9;
        font-size: 1rem;
    }

    .step-indicators {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: var(--light-color);
        border-bottom: 1px solid var(--border-color);
    }

    .step-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .step-indicator.active {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .step-indicator.completed {
        background: var(--success-color);
        color: white;
    }

    .step-indicator.pending {
        background: var(--light-color);
        color: var(--secondary-color);
        border: 2px solid var(--border-color);
    }

    .step-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
    }

    /* Form Sections */
    .form-section {
        padding: 2rem;
        display: none;
    }

    .form-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 1.25rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .form-group {
        position: relative;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-input.error {
        border-color: var(--danger-color);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .form-input.success {
        border-color: var(--success-color);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .error-message {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
        font-weight: 500;
    }

    .error-message.show {
        display: block;
    }

    .success-message {
        color: var(--success-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
        font-weight: 500;
    }

    .success-message.show {
        display: block;
    }

    .form-input.has-icon {
        padding-left: 3rem;
    }

    .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        font-size: 1rem;
    }

    .form-textarea {
        min-height: 120px;
        resize: vertical;
    }

    /* Dynamic Sections */
    .dynamic-section {
        background: var(--light-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 2px dashed var(--border-color);
        transition: all 0.3s ease;
    }

    .dynamic-section:hover {
        border-color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
    }

    .section-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .section-title-small {
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
    }

    .remove-section {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .remove-section:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    /* Add Section Button */
    .add-section-btn {
        background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .add-section-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Navigation Buttons */
    .wizard-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: var(--light-color);
        border-top: 1px solid var(--border-color);
    }

    .nav-btn {
        padding: 0.875rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .nav-btn.prev {
        background: var(--light-color);
        color: var(--secondary-color);
        border: 2px solid var(--border-color);
    }

    .nav-btn.prev:hover {
        background: var(--border-color);
        color: var(--dark-color);
    }

    .nav-btn.next {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        border: none;
    }

    .nav-btn.next:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .nav-btn.generate {
        background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        color: white;
        border: none;
    }

    .nav-btn.generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Progress Bar */
    .progress-container {
        padding: 0 2rem 1.5rem;
        background: var(--light-color);
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .progress-text {
        text-align: center;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--secondary-color);
        font-weight: 500;
    }

    /* Preview Section */
    .preview-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-top: 2rem;
    }

    .preview-header {
        background: linear-gradient(135deg, var(--accent-color) 0%, #d97706 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
    }

    .preview-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .preview-content {
        padding: 2rem;
        min-height: 400px;
        background: #f8f9fa;
    }

    .preview-placeholder {
        text-align: center;
        color: var(--secondary-color);
        padding: 3rem;
    }

    .preview-placeholder i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .builder-title {
            font-size: 2rem;
        }
        
        .step-indicators {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .step-indicator {
            width: 100%;
            justify-content: center;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .wizard-navigation {
            flex-direction: column;
            gap: 1rem;
        }
        
        .nav-btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Loading States */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-content {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        max-width: 400px;
        margin: 0 1rem;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="resume-builder-container">
    <div class="container">
        <!-- Header -->
        <div class="builder-header">
            <h1 class="builder-title">Resume Builder</h1>
            <p class="builder-subtitle">Create a professional resume with AI-powered guidance and real-time preview</p>
        </div>

        <!-- Step Wizard -->
        <div class="step-wizard">
            <div class="wizard-header">
                <h2 class="wizard-title">Build Your Professional Resume</h2>
                <p class="wizard-subtitle">Follow the steps below to create your perfect resume</p>
            </div>

            <!-- Step Indicators -->
            <div class="step-indicators">
                <div class="step-indicator active" data-step="1">
                    <div class="step-number">1</div>
                    <span>Basic Info</span>
                </div>
                <div class="step-indicator pending" data-step="2">
                    <div class="step-number">2</div>
                    <span>Education</span>
                </div>
                <div class="step-indicator pending" data-step="3">
                    <div class="step-number">3</div>
                    <span>Experience</span>
                </div>
                <div class="step-indicator pending" data-step="4">
                    <div class="step-number">4</div>
                    <span>Skills & Projects</span>
                </div>
                <div class="step-indicator pending" data-step="5">
                    <div class="step-number">5</div>
                    <span>Review & Generate</span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 20%"></div>
                </div>
                <div class="progress-text" id="progress-text">Step 1 of 5: Basic Information</div>
            </div>

            <!-- Form Sections -->
            <form id="resume-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Step 1: Basic Information -->
                <div class="form-section active" id="step-1">
                    <h3 class="section-title">
                        <i class="fas fa-user"></i>
                        Basic Information
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-input has-icon" name="name" placeholder="Your Full Name" required>
                            <i class="fas fa-user input-icon"></i>
                            <div class="error-message" id="name-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-input has-icon" name="email" placeholder="your.email@example.com" required>
                            <i class="fas fa-envelope input-icon"></i>
                            <div class="error-message" id="email-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input has-icon" name="phone" placeholder="+1 (555) 123-4567">
                            <i class="fas fa-phone input-icon"></i>
                            <div class="error-message" id="phone-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">LinkedIn Profile</label>
                            <input type="url" class="form-input has-icon" name="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                            <i class="fab fa-linkedin input-icon"></i>
                            <div class="error-message" id="linkedin-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">GitHub Profile</label>
                            <input type="url" class="form-input has-icon" name="github" placeholder="https://github.com/yourusername">
                            <i class="fab fa-github input-icon"></i>
                            <div class="error-message" id="github-error"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Education -->
                <div class="form-section" id="step-2">
                    <h3 class="section-title">
                        <i class="fas fa-graduation-cap"></i>
                        Education
                    </h3>
                    <div id="education-sections">
                        <div class="dynamic-section education-item">
                            <div class="section-header">
                                <h4 class="section-title-small">Education Entry #1</h4>
                                <button type="button" class="remove-section" onclick="removeSection(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Degree *</label>
                                    <input type="text" class="form-input" name="education_degree[]" placeholder="e.g., Bachelor of Science in Computer Science" required>
                                    <div class="error-message" id="education_degree-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Institution *</label>
                                    <input type="text" class="form-input" name="education_school[]" placeholder="University Name" required>
                                    <div class="error-message" id="education_school-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Graduation Year *</label>
                                    <input type="number" class="form-input" name="education_year[]" placeholder="2020" min="1950" max="2030" required>
                                    <div class="error-message" id="education_year-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">GPA (Optional)</label>
                                    <input type="text" class="form-input" name="education_gpa[]" placeholder="3.8">
                                    <div class="error-message" id="education_gpa-error-0"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-section-btn" onclick="addEducationSection()">
                        <i class="fas fa-plus"></i>
                        Add Another Education Entry
                    </button>
                </div>

                <!-- Step 3: Experience -->
                <div class="form-section" id="step-3">
                    <h3 class="section-title">
                        <i class="fas fa-briefcase"></i>
                        Work Experience
                    </h3>
                    <div id="experience-sections">
                        <div class="dynamic-section experience-item">
                            <div class="section-header">
                                <h4 class="section-title-small">Experience Entry #1</h4>
                                <button type="button" class="remove-section" onclick="removeSection(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Job Title *</label>
                                    <input type="text" class="form-input" name="experience_title[]" placeholder="e.g., Software Engineer" required>
                                    <div class="error-message" id="experience_title-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Company *</label>
                                    <input type="text" class="form-input" name="experience_company[]" placeholder="Company Name" required>
                                    <div class="error-message" id="experience_company-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Start Date *</label>
                                    <input type="month" class="form-input" name="experience_start[]" required>
                                    <div class="error-message" id="experience_start-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Date</label>
                                    <input type="month" class="form-input" name="experience_end[]" placeholder="Present">
                                    <div class="error-message" id="experience_end-error-0"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Job Description *</label>
                                <textarea class="form-input form-textarea" name="experience_description[]" placeholder="Describe your responsibilities and achievements..." required></textarea>
                                <div class="error-message" id="experience_description-error-0"></div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-section-btn" onclick="addExperienceSection()">
                        <i class="fas fa-plus"></i>
                        Add Another Experience Entry
                    </button>
                </div>

                <!-- Step 4: Skills & Projects -->
                <div class="form-section" id="step-4">
                    <h3 class="section-title">
                        <i class="fas fa-code"></i>
                        Skills & Projects
                    </h3>
                    
                    <!-- Skills Section -->
                    <div class="form-group">
                        <label class="form-label">Technical Skills *</label>
                        <textarea class="form-input form-textarea" name="skills" placeholder="Enter your technical skills (e.g., Python, JavaScript, React, AWS, Docker...)" required></textarea>
                        <div class="error-message" id="skills-error"></div>
                    </div>

                    <!-- Projects Section -->
                    <h4 class="section-title-small" style="margin-top: 2rem; margin-bottom: 1rem;">
                        <i class="fas fa-project-diagram"></i>
                        Projects
                    </h4>
                    <div id="project-sections">
                        <div class="dynamic-section project-item">
                            <div class="section-header">
                                <h4 class="section-title-small">Project #1</h4>
                                <button type="button" class="remove-section" onclick="removeSection(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Project Name *</label>
                                    <input type="text" class="form-input" name="project_name[]" placeholder="e.g., E-commerce Platform" required>
                                    <div class="error-message" id="project_name-error-0"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Technologies Used</label>
                                    <input type="text" class="form-input" name="project_tech[]" placeholder="e.g., React, Node.js, MongoDB">
                                    <div class="error-message" id="project_tech-error-0"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Project Description *</label>
                                <textarea class="form-input form-textarea" name="project_description[]" placeholder="Describe what the project does and your role..." required></textarea>
                                <div class="error-message" id="project_description-error-0"></div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-section-btn" onclick="addProjectSection()">
                        <i class="fas fa-plus"></i>
                        Add Another Project
                    </button>
                </div>

                <!-- Step 5: Review & Generate -->
                <div class="form-section" id="step-5">
                    <h3 class="section-title">
                        <i class="fas fa-eye"></i>
                        Review & Generate
                    </h3>
                    <div class="preview-section">
                        <div class="preview-header">
                            <h4 class="preview-title">Resume Preview</h4>
                            <p>Review your information before generating</p>
                        </div>
                        <div class="preview-content" id="resume-preview">
                            <div class="preview-placeholder">
                                <i class="fas fa-file-alt"></i>
                                <h5>Resume Preview</h5>
                                <p>Fill out the previous steps to see your resume preview here</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="wizard-navigation">
                    <button type="button" class="nav-btn prev" id="prev-btn" onclick="previousStep()" disabled>
                        <i class="fas fa-arrow-left"></i>
                        Previous
                    </button>
                    <button type="button" class="nav-btn next" id="next-btn" onclick="nextStep()">
                        Next
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="submit" class="nav-btn generate" id="generate-btn" style="display: none;">
                        <i class="fas fa-magic"></i>
                        Generate Resume
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h4>Generating Your Resume...</h4>
        <p>Please wait while we create your professional resume with AI assistance.</p>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 5;

document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    updateNavigation();
    updateStepIndicators();
    
    // Add real-time validation to existing form fields
    addRealTimeValidation(document);
});

function nextStep() {
    if (currentStep < totalSteps) {
        if (validateCurrentStep()) {
            currentStep++;
            updateStepIndicators();
            updateProgress();
            updateNavigation();
            showCurrentStep();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepIndicators();
        updateProgress();
        updateNavigation();
        showCurrentStep();
    }
}

function showCurrentStep() {
    // Hide all sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show current section
    document.getElementById(`step-${currentStep}`).classList.add('active');
    
    // Update preview if on last step
    if (currentStep === 5) {
        updatePreview();
    }
}

function updateStepIndicators() {
    document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const stepNumber = index + 1;
        indicator.classList.remove('active', 'completed', 'pending');
        
        if (stepNumber < currentStep) {
            indicator.classList.add('completed');
        } else if (stepNumber === currentStep) {
            indicator.classList.add('active');
        } else {
            indicator.classList.add('pending');
        }
    });
}

function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progress-fill').style.width = `${progress}%`;
    
    const stepNames = [
        'Basic Information',
        'Education',
        'Work Experience',
        'Skills & Projects',
        'Review & Generate'
    ];
    
    document.getElementById('progress-text').textContent = `Step ${currentStep} of ${totalSteps}: ${stepNames[currentStep - 1]}`;
}

function updateNavigation() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const generateBtn = document.getElementById('generate-btn');
    
    prevBtn.disabled = currentStep === 1;
    
    if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
        generateBtn.style.display = 'flex';
    } else {
        nextBtn.style.display = 'flex';
        generateBtn.style.display = 'none';
    }
}

function validateCurrentStep() {
    const currentSection = document.getElementById(`step-${currentStep}`);
    const requiredFields = currentSection.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            field.style.borderColor = 'var(--danger-color)';
            return false;
        } else {
            field.style.borderColor = '';
        }
    }
    
    return true;
}

function addEducationSection() {
    const container = document.getElementById('education-sections');
    const sectionCount = container.children.length + 1;
    
    const newSection = document.createElement('div');
    newSection.className = 'dynamic-section education-item';
    newSection.innerHTML = `
        <div class="section-header">
            <h4 class="section-title-small">Education Entry #${sectionCount}</h4>
            <button type="button" class="remove-section" onclick="removeSection(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Degree *</label>
                <input type="text" class="form-input" name="education_degree[]" placeholder="e.g., Bachelor of Science in Computer Science" required>
                <div class="error-message" id="education_degree-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Institution *</label>
                <input type="text" class="form-input" name="education_school[]" placeholder="University Name" required>
                <div class="error-message" id="education_school-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Graduation Year *</label>
                <input type="number" class="form-input" name="education_year[]" placeholder="2020" min="1950" max="2030" required>
                <div class="error-message" id="education_year-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">GPA (Optional)</label>
                <input type="text" class="form-input" name="education_gpa[]" placeholder="3.8">
                <div class="error-message" id="education_gpa-error-${sectionCount - 1}"></div>
            </div>
        </div>
    `;
    
    container.appendChild(newSection);
    updateSectionNumbers('education-sections', 'Education Entry');
    addRealTimeValidation(newSection);
}

function addExperienceSection() {
    const container = document.getElementById('experience-sections');
    const sectionCount = container.children.length + 1;
    
    const newSection = document.createElement('div');
    newSection.className = 'dynamic-section experience-item';
    newSection.innerHTML = `
        <div class="section-header">
            <h4 class="section-title-small">Experience Entry #${sectionCount}</h4>
            <button type="button" class="remove-section" onclick="removeSection(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Job Title *</label>
                <input type="text" class="form-input" name="experience_title[]" placeholder="e.g., Software Engineer" required>
                <div class="error-message" id="experience_title-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Company *</label>
                <input type="text" class="form-input" name="experience_company[]" placeholder="Company Name" required>
                <div class="error-message" id="experience_company-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Start Date *</label>
                <input type="month" class="form-input" name="experience_start[]" required>
                <div class="error-message" id="experience_start-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="month" class="form-input" name="experience_end[]" placeholder="Present">
                <div class="error-message" id="experience_end-error-${sectionCount - 1}"></div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Job Description *</label>
            <textarea class="form-input form-textarea" name="experience_description[]" placeholder="Describe your responsibilities and achievements..." required></textarea>
            <div class="error-message" id="experience_description-error-${sectionCount - 1}"></div>
        </div>
    `;
    
    container.appendChild(newSection);
    updateSectionNumbers('experience-sections', 'Experience Entry');
    addRealTimeValidation(newSection);
}

function addProjectSection() {
    const container = document.getElementById('project-sections');
    const sectionCount = container.children.length + 1;
    
    const newSection = document.createElement('div');
    newSection.className = 'dynamic-section project-item';
    newSection.innerHTML = `
        <div class="section-header">
            <h4 class="section-title-small">Project #${sectionCount}</h4>
            <button type="button" class="remove-section" onclick="removeSection(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Project Name *</label>
                <input type="text" class="form-input" name="project_name[]" placeholder="e.g., E-commerce Platform" required>
                <div class="error-message" id="project_name-error-${sectionCount - 1}"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Technologies Used</label>
                <input type="text" class="form-input" name="project_tech[]" placeholder="e.g., React, Node.js, MongoDB">
                <div class="error-message" id="project_tech-error-${sectionCount - 1}"></div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Project Description *</label>
            <textarea class="form-input form-textarea" name="project_description[]" placeholder="Describe what the project does and your role..." required></textarea>
            <div class="error-message" id="project_description-error-${sectionCount - 1}"></div>
        </div>
    `;
    
    container.appendChild(newSection);
    updateSectionNumbers('project-sections', 'Project');
    addRealTimeValidation(newSection);
}

function removeSection(button) {
    const section = button.closest('.dynamic-section');
    const container = section.parentElement;
    
    if (container.children.length > 1) {
        section.remove();
        updateSectionNumbers(container.id, getSectionType(container.id));
    }
}

function updateSectionNumbers(containerId, sectionType) {
    const container = document.getElementById(containerId);
    const sections = container.querySelectorAll('.section-title-small');
    
    sections.forEach((title, index) => {
        title.textContent = `${sectionType} #${index + 1}`;
    });
}

function getSectionType(containerId) {
    const types = {
        'education-sections': 'Education Entry',
        'experience-sections': 'Experience Entry',
        'project-sections': 'Project'
    };
    return types[containerId] || 'Section';
}

function updatePreview() {
    const preview = document.getElementById('resume-preview');
    const formData = new FormData(document.getElementById('resume-form'));
    
    // Create a simple preview
    let previewHTML = `
        <div style="font-family: 'Arial', sans-serif; line-height: 1.6;">
            <h2 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem;">
                ${formData.get('name') || 'Your Name'}
            </h2>
            <p style="color: var(--secondary-color); margin-bottom: 1rem;">
                ${formData.get('email') || 'email@example.com'} | 
                ${formData.get('phone') || 'Phone'} | 
                ${formData.get('linkedin') ? `<a href="${formData.get('linkedin')}" target="_blank">LinkedIn</a>` : ''}
            </p>
            
            <h3 style="color: var(--dark-color); margin-top: 2rem;">Education</h3>
            <div style="margin-bottom: 1rem;">
                <strong>${formData.get('education_degree[]') || 'Degree'}</strong><br>
                ${formData.get('education_school[]') || 'Institution'} | ${formData.get('education_year[]') || 'Year'}
                ${formData.get('education_gpa[]') ? `| GPA: ${formData.get('education_gpa[]')}` : ''}
            </div>
            
            <h3 style="color: var(--dark-color); margin-top: 2rem;">Experience</h3>
            <div style="margin-bottom: 1rem;">
                <strong>${formData.get('experience_title[]') || 'Job Title'}</strong><br>
                ${formData.get('experience_company[]') || 'Company'} | ${formData.get('experience_start[]') || 'Start'} - ${formData.get('experience_end[]') || 'End'}<br>
                ${formData.get('experience_description[]') || 'Description'}
            </div>
            
            <h3 style="color: var(--dark-color); margin-top: 2rem;">Skills</h3>
            <p>${formData.get('skills') || 'Your skills will appear here'}</p>
            
            <h3 style="color: var(--dark-color); margin-top: 2rem;">Projects</h3>
            <div style="margin-bottom: 1rem;">
                <strong>${formData.get('project_name[]') || 'Project Name'}</strong><br>
                ${formData.get('project_tech[]') ? `Technologies: ${formData.get('project_tech[]')}<br>` : ''}
                ${formData.get('project_description[]') || 'Project description'}
            </div>
        </div>
    `;
    
    preview.innerHTML = previewHTML;
}

// Form submission
document.getElementById('resume-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields first
    if (!validateForm()) {
        return;
    }
    
    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';
    
    // Convert form data to JSON format for backend
    const formData = new FormData(this);
    const jsonData = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        linkedin: formData.get('linkedin'),
        github: formData.get('github'),
        education: [],
        experience: [],
        projects: [],
        skills: {},
        research_papers: [],
        achievements: [],
        others: []
    };
    
    // Process education
    const degrees = formData.getAll('education_degree[]');
    const schools = formData.getAll('education_school[]');
    const years = formData.getAll('education_year[]');
    const gpas = formData.getAll('education_gpa[]');
    
    for (let i = 0; i < degrees.length; i++) {
        if (degrees[i]) {
            jsonData.education.push({
                degree: degrees[i],
                institution: schools[i] || '',
                duration: years[i] || '',
                location: '', // Add location field if needed
                gpa: gpas[i] || ''
            });
        }
    }
    
    // Process experience
    const titles = formData.getAll('experience_title[]');
    const companies = formData.getAll('experience_company[]');
    const starts = formData.getAll('experience_start[]');
    const ends = formData.getAll('experience_end[]');
    const descriptions = formData.getAll('experience_description[]');
    
    for (let i = 0; i < titles.length; i++) {
        if (titles[i]) {
            jsonData.experience.push({
                title: titles[i],
                company: companies[i] || '',
                duration: `${starts[i] || ''} - ${ends[i] || 'Present'}`,
                location: '', // Add location field if needed
                description: descriptions[i] ? [descriptions[i]] : []
            });
        }
    }
    
    // Process projects
    const projectNames = formData.getAll('project_name[]');
    const projectTechs = formData.getAll('project_tech[]');
    const projectDescriptions = formData.getAll('project_description[]');
    
    for (let i = 0; i < projectNames.length; i++) {
        if (projectNames[i]) {
            jsonData.projects.push({
                name: projectNames[i],
                tech_stack: projectTechs[i] || '',
                description: projectDescriptions[i] ? [projectDescriptions[i]] : []
            });
        }
    }
    
    // Process skills - convert to the expected format
    const skillsText = formData.get('skills');
    if (skillsText) {
        // Parse skills text into categories
        const skillsList = skillsText.split(',').map(s => s.trim()).filter(s => s);
        jsonData.skills = {
            'Programming Languages': skillsList.filter(s => 
                ['Python', 'JavaScript', 'Java', 'C++', 'C#', 'Go', 'Rust', 'PHP', 'Ruby', 'Swift', 'Kotlin'].some(lang => 
                    s.toLowerCase().includes(lang.toLowerCase())
                )
            ),
            'Frameworks & Libraries': skillsList.filter(s => 
                ['React', 'Django', 'Flask', 'Node.js', 'Express', 'Angular', 'Vue', 'Spring', 'Laravel', 'TensorFlow', 'PyTorch'].some(fw => 
                    s.toLowerCase().includes(fw.toLowerCase())
                )
            ),
            'Tools & Technologies': skillsList.filter(s => 
                ['Git', 'Docker', 'AWS', 'Azure', 'GCP', 'Kubernetes', 'Jenkins', 'MongoDB', 'PostgreSQL', 'MySQL', 'Redis'].some(tool => 
                    s.toLowerCase().includes(tool.toLowerCase())
                )
            ),
            'Other Skills': skillsList.filter(s => 
                !['Python', 'JavaScript', 'Java', 'C++', 'C#', 'Go', 'Rust', 'PHP', 'Ruby', 'Swift', 'Kotlin', 'React', 'Django', 'Flask', 'Node.js', 'Express', 'Angular', 'Vue', 'Spring', 'Laravel', 'TensorFlow', 'PyTorch', 'Git', 'Docker', 'AWS', 'Azure', 'GCP', 'Kubernetes', 'Jenkins', 'MongoDB', 'PostgreSQL', 'MySQL', 'Redis'].some(skill => 
                    s.toLowerCase().includes(skill.toLowerCase())
                )
            )
        };
        
        // Remove empty categories
        Object.keys(jsonData.skills).forEach(key => {
            if (jsonData.skills[key].length === 0) {
                delete jsonData.skills[key];
            }
        });
    }
    
    // Add hidden fields with JSON data
    const hiddenFields = ['education', 'experience', 'projects', 'skills', 'research_papers', 'achievements', 'others'];
    hiddenFields.forEach(field => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = field;
        input.value = JSON.stringify(jsonData[field]);
        this.appendChild(input);
    });
    
    // Submit the form
    this.submit();
});

function validateForm() {
    let isValid = true;
    
    // Clear all previous errors
    clearAllErrors();
    
    // Validate required fields
    const requiredFields = [
        { name: 'name', message: 'Please enter your full name' },
        { name: 'email', message: 'Please enter your email address' },
        { name: 'education_degree[]', message: 'Please enter at least one education entry' },
        { name: 'project_name[]', message: 'Please enter at least one project' },
        { name: 'skills', message: 'Please enter your skills' }
    ];
    
    for (const field of requiredFields) {
        const elements = document.querySelectorAll(`[name="${field.name}"]`);
        let hasValue = false;
        
        for (const element of elements) {
            if (element.value && element.value.trim()) {
                hasValue = true;
                break;
            }
        }
        
        if (!hasValue) {
            showFieldError(field.name, field.message);
            elements[0]?.focus();
            isValid = false;
        }
    }
    
    // Validate email format
    const email = document.querySelector('[name="email"]').value;
    if (email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showFieldError('email', 'Please enter a valid email address (e.g., user@example.com)');
            isValid = false;
        }
    }
    
    // Validate phone format (if provided)
    const phone = document.querySelector('[name="phone"]').value;
    if (phone && phone.trim() !== '') {
        const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
        if (!phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''))) {
            showFieldError('phone', 'Please enter a valid phone number (e.g., +1 555 123 4567)');
            isValid = false;
        }
    }
    
    // Validate graduation years
    const graduationYears = document.querySelectorAll('[name="education_year[]"]');
    const currentYear = new Date().getFullYear();
    graduationYears.forEach((yearInput, index) => {
        if (yearInput.value) {
            const year = parseInt(yearInput.value);
            if (year < 1950 || year > currentYear + 10) {
                showFieldError(`education_year[]`, `Please enter a valid graduation year between 1950 and ${currentYear + 10}`, index);
                isValid = false;
            }
        }
    });
    
    // Validate experience dates
    const startDates = document.querySelectorAll('[name="experience_start[]"]');
    const endDates = document.querySelectorAll('[name="experience_end[]"]');
    
    for (let i = 0; i < startDates.length; i++) {
        const startDate = startDates[i].value;
        const endDate = endDates[i].value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end < start) {
                showFieldError('experience_end[]', 'End date cannot be before start date', i);
                isValid = false;
            }
            
            // Check if dates are too far in the future
            const maxFutureDate = new Date();
            maxFutureDate.setFullYear(maxFutureDate.getFullYear() + 2);
            
            if (start > maxFutureDate) {
                showFieldError('experience_start[]', 'Start date cannot be more than 2 years in the future', i);
                isValid = false;
            }
        }
    }
    
    // Validate URLs (if provided)
    const linkedin = document.querySelector('[name="linkedin"]').value;
    const github = document.querySelector('[name="github"]').value;
    
    if (linkedin && !isValidUrl(linkedin)) {
        showFieldError('linkedin', 'Please enter a valid LinkedIn URL (e.g., https://linkedin.com/in/yourprofile)');
        isValid = false;
    }
    
    if (github && !isValidUrl(github)) {
        showFieldError('github', 'Please enter a valid GitHub URL (e.g., https://github.com/yourusername)');
        isValid = false;
    }
    
    return isValid;
}

function showFieldError(fieldName, message, index = 0) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (!field) return;
    
    // Find the error element
    let errorElement;
    if (fieldName.includes('[]')) {
        const fieldIndex = Array.from(document.querySelectorAll(`[name="${fieldName}"]`)).indexOf(field);
        errorElement = document.getElementById(`${fieldName.replace('[]', '')}-error-${fieldIndex}`);
    } else {
        errorElement = document.getElementById(`${fieldName}-error`);
    }
    
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.add('show');
        field.classList.add('error');
        field.classList.remove('success');
    }
}

function clearFieldError(fieldName, index = 0) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (!field) return;
    
    let errorElement;
    if (fieldName.includes('[]')) {
        const fieldIndex = Array.from(document.querySelectorAll(`[name="${fieldName}"]`)).indexOf(field);
        errorElement = document.getElementById(`${fieldName.replace('[]', '')}-error-${fieldIndex}`);
    } else {
        errorElement = document.getElementById(`${fieldName}-error`);
    }
    
    if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.remove('show');
        field.classList.remove('error');
        field.classList.add('success');
    }
}

function clearAllErrors() {
    document.querySelectorAll('.error-message').forEach(error => {
        error.textContent = '';
        error.classList.remove('show');
    });
    
    document.querySelectorAll('.form-input').forEach(input => {
        input.classList.remove('error', 'success');
    });
}

function addRealTimeValidation(section) {
    const inputs = section.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });
        
        input.addEventListener('input', function() {
            if (this.classList.contains('error')) {
                validateField(this);
            }
        });
    });
}

function validateField(field) {
    const fieldName = field.name;
    const value = field.value.trim();
    
    // Clear previous error
    clearFieldError(fieldName);
    
    // Required field validation
    if (field.hasAttribute('required') && !value) {
        showFieldError(fieldName, 'This field is required');
        return false;
    }
    
    // Email validation
    if (fieldName === 'email' && value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
            showFieldError(fieldName, 'Please enter a valid email address (e.g., user@example.com)');
            return false;
        }
    }
    
    // Phone validation
    if (fieldName === 'phone' && value) {
        const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
        if (!phoneRegex.test(value.replace(/[\s\-\(\)]/g, ''))) {
            showFieldError(fieldName, 'Please enter a valid phone number (e.g., +1 555 123 4567)');
            return false;
        }
    }
    
    // URL validation
    if ((fieldName === 'linkedin' || fieldName === 'github') && value) {
        if (!isValidUrl(value)) {
            const example = fieldName === 'linkedin' ? 'https://linkedin.com/in/yourprofile' : 'https://github.com/yourusername';
            showFieldError(fieldName, `Please enter a valid ${fieldName} URL (e.g., ${example})`);
            return false;
        }
    }
    
    // Year validation
    if (fieldName === 'education_year[]' && value) {
        const year = parseInt(value);
        const currentYear = new Date().getFullYear();
        if (year < 1950 || year > currentYear + 10) {
            showFieldError(fieldName, `Please enter a valid graduation year between 1950 and ${currentYear + 10}`);
            return false;
        }
    }
    
    // Date validation for experience
    if (fieldName === 'experience_start[]' && value) {
        const start = new Date(value);
        const maxFutureDate = new Date();
        maxFutureDate.setFullYear(maxFutureDate.getFullYear() + 2);
        
        if (start > maxFutureDate) {
            showFieldError(fieldName, 'Start date cannot be more than 2 years in the future');
            return false;
        }
    }
    
    if (fieldName === 'experience_end[]' && value) {
        const fieldIndex = Array.from(document.querySelectorAll(`[name="${fieldName}"]`)).indexOf(field);
        const startField = document.querySelectorAll('[name="experience_start[]"]')[fieldIndex];
        
        if (startField && startField.value) {
            const start = new Date(startField.value);
            const end = new Date(value);
            
            if (end < start) {
                showFieldError(fieldName, 'End date cannot be before start date');
                return false;
            }
        }
    }
    
    return true;
}

function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}
</script>
{% endblock %} 
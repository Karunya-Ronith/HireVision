{% extends 'base.html' %}

{% block title %}Resume Analysis Result - HireVision{% endblock %}

{% block extra_css %}
<style>
    /* Base Layout */
    .result-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        padding: 2rem 0;
        font-family: 'Inter', sans-serif;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    /* Header Styles */
    .result-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem 0;
    }

    .result-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .result-subtitle {
        font-size: 1.125rem;
        color: var(--secondary-color);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    /* Score Card */
    .score-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .score-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.5rem;
        text-align: center;
        position: relative;
    }

    .score-header::before {
        content: '';
        position: absolute;
        inset: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.2;
    }

    .score-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .score-value {
        font-size: 3rem;
        font-weight: 800;
    }

    .score-description {
        font-size: 1rem;
        opacity: 0.9;
    }

    .score-body {
        padding: 1.5rem;
        text-align: center;
    }

    .score-explanation {
        font-size: 1rem;
        color: var(--secondary-color);
        line-height: 1.6;
        max-width: 800px;
        margin: 0 auto;
    }

    /* Analysis Grid */
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .analysis-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .analysis-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
    }

    .card-header {
        padding: 1.25rem;
        text-align: center;
        color: white;
    }

    .card-header.strengths { background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%); }
    .card-header.improvements { background: linear-gradient(135deg, var(--accent-color) 0%, #d97706 100%); }
    .card-header.recommendations { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
    .card-header.skills-gap { background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%); }
    .card-header.upskilling { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    .card-header.assessment { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }

    .card-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .card-body {
        padding: 1.25rem;
    }

    .analysis-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .analysis-list li {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--light-color);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        transition: transform 0.2s ease;
    }

    .analysis-list li:hover {
        transform: translateX(4px);
        background: rgba(37, 99, 235, 0.05);
    }

    .analysis-list i {
        font-size: 1rem;
        width: 16px;
        margin-top: 0.25rem;
    }

    .analysis-list span {
        font-weight: 500;
        color: var(--dark-color);
        line-height: 1.5;
    }

    .assessment-content {
        background: var(--light-color);
        border-radius: 8px;
        padding: 1.25rem;
        line-height: 1.6;
    }

    /* Action Section */
    .action-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    .action-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.25rem;
        text-align: center;
    }

    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        padding: 1.5rem;
    }

    .action-btn {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        border-radius: 10px;
        padding: 1rem;
        font-weight: 600;
        color: white;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
    }

    .action-btn.learning { background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%); }
    .action-btn.builder { background: linear-gradient(135deg, var(--accent-color) 0%, #d97706 100%); }
    .action-btn.analyze { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }

    /* Loading Animation */
    .loading-animation {
        position: relative;
        display: inline-block;
    }

    .ai-brain i {
        animation: brain-pulse 1.8s ease-in-out infinite;
    }

    .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70px;
        height: 70px;
        border: 2px solid var(--primary-color);
        border-radius: 50%;
        opacity: 0;
        animation: pulse 2s ease-out infinite;
    }

    .pulse-ring.delay-1 { animation-delay: 0.4s; }
    .pulse-ring.delay-2 { animation-delay: 0.8s; }

    @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0.8; }
        100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
    }

    @keyframes brain-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }

    /* Progress and Status */
    .status-container h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
    }

    .progress-container {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .progress {
        background-color: #e9ecef;
        height: 6px;
        border-radius: 8px;
    }

    .progress-bar {
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
    }

    /* Loading Tips */
    .loading-tips .tip-card {
        background: linear-gradient(135deg, #fff7e6 0%, #ffedd5 100%);
        border: 1px solid #fed7aa;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    /* Error State */
    .error-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        max-width: 500px;
        margin: 0 auto;
    }

    .error-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--danger-color);
    }

    .error-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .result-title { font-size: 2rem; }
        .score-value { font-size: 2.5rem; }
        .analysis-grid { grid-template-columns: 1fr; }
        .action-grid { grid-template-columns: 1fr; }
        .pulse-ring { width: 50px; height: 50px; }
    }

    /* Accessibility */
    .action-btn:focus, #cancel-analysis:focus {
        outline: 3px solid var(--primary-color);
        outline-offset: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="result-container" role="main">
    <div class="container">
        <!-- Header -->
        <div class="result-header">
            <h1 class="result-title">Resume Analysis Result</h1>
            <p class="result-subtitle">Your AI-Powered Resume Analysis</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state"{% if analysis.task_status == 'completed' %} style="display: none;"{% endif %} role="region" aria-live="polite">
            <div class="text-center">
                <div class="loading-animation mb-3">
                    <div class="ai-brain">
                        <i class="fas fa-brain fa-2x text-primary" aria-hidden="true"></i>
                        <div class="pulse-ring"></div>
                        <div class="pulse-ring delay-1"></div>
                        <div class="pulse-ring delay-2"></div>
                    </div>
                </div>
                
                <div class="status-container mb-3">
                    <h3 id="status-title">Initializing Analysis...</h3>
                    <p id="status-description" class="text-muted">Preparing AI models and processing your resume</p>
                </div>
                
                <div class="progress-container">
                    <div class="progress mb-2">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small id="progress-text">0% Complete</small>
                        <small id="time-estimate">Estimated: ~45s</small>
                    </div>
                </div>
                
                <div class="loading-tips mt-3">
                    <div class="tip-card">
                        <i class="fas fa-lightbulb text-warning" aria-hidden="true"></i>
                        <span id="loading-tip">Review your job description to match your target role.</span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button id="cancel-analysis" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-times me-1" aria-hidden="true"></i>Cancel Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" style="display: none;" role="alert">
            <div class="error-container text-center">
                <div class="error-icon mb-3">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger" aria-hidden="true"></i>
                </div>
                <h3 class="error-title">Analysis Failed</h3>
                <p id="error-message" class="text-muted">An error occurred. Please try again.</p>
                
                <div class="error-actions mb-3">
                    <a href="{% url 'hirevision:resume_analyzer' %}" class="btn btn-primary">
                        <i class="fas fa-redo me-1" aria-hidden="true"></i>Try Again
                    </a>
                    <button onclick="window.location.reload()" class="btn btn-outline-secondary">
                        <i class="fas fa-refresh me-1" aria-hidden="true"></i>Refresh
                    </button>
                </div>
                
                <div class="error-help">
                    <h5>Need Help?</h5>
                    <ul class="text-muted text-start">
                        <li>Check your internet connection</li>
                        <li>Use PDF format for your resume</li>
                        <li>Ensure job description is detailed</li>
                        <li>Contact support if issues persist</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Results Content -->
        <div id="results-content"{% if analysis.task_status != 'completed' %} style="display: none;"{% endif %} role="region">
            <div class="row justify-content-center">
                <div class="col-lg-12">
                    <!-- ATS Score Card -->
                    <div class="score-card">
                        <div class="score-header">
                            <h2 class="score-title">
                                <i class="fas fa-chart-line me-1" aria-hidden="true"></i>ATS Score
                            </h2>
                            <div class="score-value">{{ analysis.ats_score }}/100</div>
                            <p class="score-description">Analysis completed successfully</p>
                        </div>
                        <div class="score-body">
                            <p class="score-explanation">{{ analysis.score_explanation }}</p>
                        </div>
                    </div>

                    <!-- Analysis Grid -->
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <div class="card-header strengths">
                                <h3><i class="fas fa-plus-circle me-1" aria-hidden="true"></i>Strengths</h3>
                                <p>What you're doing right</p>
                            </div>
                            <div class="card-body">
                                {% if analysis.strengths %}
                                    <ul class="analysis-list" role="list">
                                        {% for strength in analysis.strengths %}
                                            <li class="strengths">
                                                <i class="fas fa-check" aria-hidden="true"></i>
                                                <span>{{ strength }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                                        <p>No strengths identified.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="analysis-card">
                            <div class="card-header improvements">
                                <h3><i class="fas fa-exclamation-triangle me-1" aria-hidden="true"></i>Areas for Improvement</h3>
                                <p>What needs enhancement</p>
                            </div>
                            <div class="card-body">
                                {% if analysis.weaknesses %}
                                    <ul class="analysis-list" role="list">
                                        {% for weakness in analysis.weaknesses %}
                                            <li class="improvements">
                                                <i class="fas fa-arrow-right" aria-hidden="true"></i>
                                                <span>{{ weakness }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                                        <p>No areas for improvement identified.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="analysis-card">
                            <div class="card-header recommendations">
                                <h3><i class="fas fa-lightbulb me-1" aria-hidden="true"></i>Recommendations</h3>
                                <p>Actionable advice</p>
                            </div>
                            <div class="card-body">
                                {% if analysis.recommendations %}
                                    <ul class="analysis-list" role="list">
                                        {% for rec in analysis.recommendations %}
                                            <li class="recommendations">
                                                <i class="fas fa-arrow-right" aria-hidden="true"></i>
                                                <span>{{ rec }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                                        <p>No recommendations available.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="analysis-card">
                            <div class="card-header skills-gap">
                                <h3><i class="fas fa-gap me-1" aria-hidden="true"></i>Skills Gap Analysis</h3>
                                <p>Missing competencies</p>
                            </div>
                            <div class="card-body">
                                {% if analysis.skills_gap %}
                                    <ul class="analysis-list" role="list">
                                        {% for skill in analysis.skills_gap %}
                                            <li class="skills-gap">
                                                <i class="fas fa-times" aria-hidden="true"></i>
                                                <span>{{ skill }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                                        <p>No skills gaps identified.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="analysis-card">
                            <div class="card-header upskilling">
                                <h3><i class="fas fa-graduation-cap me-1" aria-hidden="true"></i>Upskilling Suggestions</h3>
                                <p>Learning recommendations</p>
                            </div>
                            <div class="card-body">
                                {% if analysis.upskilling_suggestions %}
                                    <ul class="analysis-list" role="list">
                                        {% for suggestion in analysis.upskilling_suggestions %}
                                            <li class="upskilling">
                                                <i class="fas fa-graduation-cap" aria-hidden="true"></i>
                                                <span>{{ suggestion }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                                        <p>No upskilling suggestions available.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="analysis-card" style="grid-column: 1 / -1;">
                            <div class="card-header assessment">
                                <h3><i class="fas fa-clipboard-check me-1" aria-hidden="true"></i>Overall Assessment</h3>
                                <p>Comprehensive evaluation</p>
                            </div>
                            <div class="card-body">
                                <div class="assessment-content">
                                    {{ analysis.overall_assessment|linebreaks }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Section -->
                    <div class="action-section">
                        <div class="action-header">
                            <h3><i class="fas fa-rocket me-1" aria-hidden="true"></i>What's Next?</h3>
                            <p>Take action to improve your career prospects</p>
                        </div>
                        <div class="action-grid">
                            <a href="{% url 'hirevision:learning_path_analyzer' %}" class="action-btn learning">
                                <i class="fas fa-road" aria-hidden="true"></i>
                                <div>
                                    <div>Plan Learning Path</div>
                                    <small>Create a personalized roadmap</small>
                                </div>
                            </a>
                            <a href="{% url 'hirevision:resume_builder' %}" class="action-btn builder">
                                <i class="fas fa-tools" aria-hidden="true"></i>
                                <div>
                                    <div>Build New Resume</div>
                                    <small>Create an optimized resume</small>
                                </div>
                            </a>
                            <a href="{% url 'hirevision:resume_analyzer' %}" class="action-btn analyze">
                                <i class="fas fa-redo" aria-hidden="true"></i>
                                <div>
                                    <div>Analyze Another</div>
                                    <small>Test a different resume</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const resultsContent = document.getElementById('results-content');
    const analysisId = '{{ analysis.id }}';
    const taskStatus = '{{ analysis.task_status }}';
    
    let startTime = Date.now();
    let pollCount = 0;
    let progressInterval, tipInterval;
    
    const statusMessages = [
        { title: 'Initializing Analysis...', description: 'Preparing AI models and processing your resume', progress: 10 },
        { title: 'Extracting Content...', description: 'Parsing your resume document', progress: 30 },
        { title: 'Analyzing Job Fit...', description: 'Matching with job requirements', progress: 50 },
        { title: 'Generating ATS Score...', description: 'Calculating compatibility score', progress: 70 },
        { title: 'Finalizing Report...', description: 'Preparing detailed feedback', progress: 90 }
    ];
    
    const loadingTips = [
        'Review your job description to align with your target role.',
        'ATS systems prioritize keywords from job descriptions.',
        'Quantify achievements with metrics for stronger impact.',
        'Tailor your resume summary to the job requirements.',
        'Ensure your LinkedIn profile is current.'
    ];
    
    if (taskStatus !== 'completed') {
        startProgressSimulation();
        startTipRotation();
        pollTaskStatus();
    }
    
    document.getElementById('cancel-analysis').addEventListener('click', async () => {
        if (confirm('Cancel analysis? You will need to start over.')) {
            try {
                await fetch(`/api/resume-analysis/${analysisId}/cancel/`, { method: 'POST' });
                window.location.href = '{% url "hirevision:resume_analyzer" %}';
            } catch (error) {
                showError('Failed to cancel analysis. Please try again.');
            }
        }
    });
    
    function startProgressSimulation() {
        let currentProgress = 0;
        let currentStage = 0;
        
        progressInterval = setInterval(() => {
            if (currentProgress < 90) {
                currentProgress += Math.random() * 3;
                updateProgress(currentProgress);
                
                if (currentProgress > statusMessages[currentStage].progress && currentStage < statusMessages.length - 1) {
                    currentStage++;
                    updateStatus(statusMessages[currentStage]);
                }
            }
        }, 800);
    }
    
    function startTipRotation() {
        let tipIndex = 0;
        tipInterval = setInterval(() => {
            document.getElementById('loading-tip').textContent = loadingTips[tipIndex];
            tipIndex = (tipIndex + 1) % loadingTips.length;
        }, 6000);
    }
    
    function updateProgress(progress) {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const timeEstimate = document.getElementById('time-estimate');
        
        progressBar.style.width = Math.min(progress, 90) + '%';
        progressBar.setAttribute('aria-valuenow', Math.round(progress));
        progressText.textContent = `${Math.round(progress)}% Complete`;
        
        const elapsed = (Date.now() - startTime) / 1000;
        const remaining = Math.max(0, 40 - elapsed);
        timeEstimate.textContent = `Estimated: ~${Math.round(remaining)}s`;
    }
    
    function updateStatus(status) {
        const title = document.getElementById('status-title');
        const description = document.getElementById('status-description');
        
        title.style.opacity = '0';
        description.style.opacity = '0';
        setTimeout(() => {
            title.textContent = status.title;
            description.textContent = status.description;
            title.style.opacity = '1';
            description.style.opacity = '1';
        }, 200);
    }
    
    async function pollTaskStatus() {
        try {
            const response = await fetch(`/api/resume-analysis/${analysisId}/status/`);
            const data = await response.json();
            
            if (data.status === 'completed') {
                clearInterval(progressInterval);
                clearInterval(tipInterval);
                updateProgress(100);
                updateStatus({ title: 'Analysis Complete!', description: 'Your results are ready' });
                
                setTimeout(() => {
                    if (data.has_results) {
                        window.location.reload();
                    } else {
                        showError('Analysis completed but no results found.');
                    }
                }, 1000);
            } else if (data.status === 'failed') {
                showError(data.error || 'Analysis failed. Please try again.');
            } else {
                pollCount++;
                const delay = Math.min(2000 + (pollCount * 300), 8000);
                setTimeout(pollTaskStatus, delay);
            }
        } catch (error) {
            if (pollCount < 5) {
                pollCount++;
                setTimeout(pollTaskStatus, 3000);
            } else {
                showError('Unable to check status. Please refresh.');
            }
        }
    }
    
    function showError(message) {
        clearInterval(progressInterval);
        clearInterval(tipInterval);
        loadingState.style.display = 'none';
        document.getElementById('error-message').textContent = message;
        errorState.style.display = 'block';
    }
});
</script>
{% endblock %}